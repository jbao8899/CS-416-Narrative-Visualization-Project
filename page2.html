<html lang="en-US">
	<head>
		<title>CS 416 Narrative Visualization Project</title>
		<script src='https://d3js.org/d3.v5.min.js'></script>
  	</head>
	<body onload='init()'>
		<!-- <div>
			<h1 id="text">Slide 2</h1>
		</div> -->

        <div>
			<svg id="svgForPlot" width=600 height=600></svg>

            
            <svg id="svgForLegend" height=375 width=300></svg>
		</div>

		<div>
			<a href="index.html">Previous Slide</a>
			<a href="page3.html">Next Slide</a>
		</div>
	</body>

	<script>
		// function init() {
        async function init() {
			// MY CODE: 
					
			// var data = d3.csv("project_2_scatterplot_data.csv");
			var data = await d3.csv("https://raw.githubusercontent.com/jbao8899/CS-416-Narrative-Visualization-Project/main/project_2_data.csv");
			
            // making bar chart for a certain year
            data = data.filter(function(d) { return d.Year == "2020" })
            // get rid of data for which fertility rate is missing
            data = data.filter(function(d) { return d.FertilityRate != "" })
            // get rid of data for which population is missing
            data = data.filter(function(d) { return d.TotalPopulation != "" })
            
            // Find population of each region
            // https://stackoverflow.com/a/40206462
            var regionPops = d3.nest()
                              .key(
                                  function(d) {
                                      return d.Region; 
                                  }
                              )
                              .rollup(
                                  function(leaves) {
                                      return d3.sum(leaves, function(d) { return d.TotalPopulation; });
                                  }
                              )
                              .entries(data)
                              .map(
                                  function(d) {
                                      return { Region: d.key, TotalPopulation: d.value};
                                  }
                              ) 
                              .reduce( // https://stackoverflow.com/a/44325124
                                  (obj, item) => Object.assign(obj, { [item.Region]: item.TotalPopulation }),
                                  {}
                              )
            
            // console.log(regionPops) // Seems right
            // console.log(regionPops["South Asia"])

            // sum these within each region to get a weighted
            // average fertility rate for that region
            data.forEach(function(d) {
                d.WeightedFertilityRate = (d.FertilityRate * d.TotalPopulation) / regionPops[d.Region]
            });

            // https://stackoverflow.com/a/40206462
            data = d3.nest()
                     .key(
                          function(d) {
                              return d.Region; 
                          }
                      )
                      .rollup(
                          function(leaves) {
                              return d3.sum(leaves, function(d) { return d.WeightedFertilityRate; });
                          }
                      )
                      .entries(data)
                      .map(
                          function(d) {
                              return { Region: d.key, WeightedMeanFertilityRate: d.value};
                          }
                      );

            // https://stackoverflow.com/a/46208867
            // Make the bars be in order, with the bar corresponding to the region with
            // the smallest weighted average fertility on the left
            // and the largest on the right
            data.sort(function(a, b) {
                return d3.ascending(a.WeightedMeanFertilityRate, b.WeightedMeanFertilityRate)
            })

            // console.log(data)
            
            var xScale = d3.scaleBand()
                           .domain(["East Asia & Pacific",
                                    "North America",
                                    "Europe & Central Asia",
                                    "Latin America & Caribbean",
                                    "South Asia",
                                    "Middle East & North Africa",
                                    "Sub-Saharan Africa"])
                                    .range([0, 400])
			var yScale = d3.scaleLinear().domain([0, 9]).range([400, 0])

            // consistent color scheme 
            var colorScale = d3.scaleOrdinal()
                               .domain(["East Asia & Pacific",
                                        "North America",
                                        "Europe & Central Asia",
                                        "Latin America & Caribbean",
                                        "South Asia",
                                        "Middle East & North Africa",
                                        "Sub-Saharan Africa"])
                               .range(["purple",
                                       "indigo",
                                       "blue",
                                       "lightblue",
                                       "green",
                                       "orange",
                                       "red"]);

			d3.select("#svgForPlot")
			  .attr("width", 400 + 2 * 100)
			  .attr("height", 400 + 2 * 100)
			  .append("g")
			  .attr("transform","translate(100, 100)")
			  .selectAll("rect")
			  .data(data)
			  .enter()
			  .append("rect")
              .attr("x", function(d, i) { return 14 + ((400 / 7) * i) })
              .attr("y", function(d) { return 400 - ((d.WeightedMeanFertilityRate / 9) * 400) })
              .attr("width", 200 / 7)
              .attr("height", function(d) { return (d.WeightedMeanFertilityRate / 9) * 400 })
              .style("fill", function(d) {return colorScale(d.Region);});
					  
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 100)")
			  .call(d3.axisLeft(yScale));
            
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 500)")
			  .call(d3.axisBottom(xScale)
					  .tickFormat(""));

            // https://stackoverflow.com/questions/11189284/d3-axis-labeling
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 535)
              .attr("font-size", "18px")
              .text("Region");

            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "y label")
              .attr("text-anchor", "middle")
              .attr("x", -300)
              .attr("y", 65)
              .attr("font-size", "18px")
              .attr("transform", "rotate(-90)")
              .text("Weighted Mean Fertility Rate");

            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 85)
              .attr("font-size", "24px")
              .text("Regional Fertility Rates (2020)");

            // Legend
            // https://d3-graph-gallery.com/graph/custom_legend.html (Categorical legend: square)
            // select the svg area
            var svgForLegend = d3.select("#svgForLegend")

            // create a list of keys
            var keys = ["East Asia & Pacific",
                        "North America",
                        "Europe & Central Asia",
                        "Latin America & Caribbean",
                        "South Asia",
                        "Middle East & North Africa",
                        "Sub-Saharan Africa"]

            // Usually you have a color scale in your chart already
            // var color = d3.scaleOrdinal()
            //     .domain(keys)
            //     .range(d3.schemeSet1);
            // I already have a colorscale

            // Add one dot in the legend for each name.
            var size = 20
            svgForLegend.selectAll("mydots")
                        .data(keys)
                        .enter()
                        .append("rect")
                        .attr("x", 100)
                        .attr("y", function(d,i){ return i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
                        .attr("width", size)
                        .attr("height", size)
                        .style("fill", function(d){ return colorScale(d)})

            // Add one dot in the legend for each name.
            svgForLegend.selectAll("mylabels")
                        .data(keys)
                        .enter()
                        .append("text")
                        .attr("x", 100 + size*1.2)
                        .attr("y", function(d,i){ return i*(size+5) + (size/2)}) // 100 is where the first dot appears. 25 is the distance between dots
                        .style("fill", function(d){ return colorScale(d)})
                        .text(function(d){ return d})
                        .attr("text-anchor", "left")
                        .style("alignment-baseline", "middle")

		}
		/*
		function changeText() {
			if (document.getElementById("text").innerHTML == "AAA") {
				document.getElementById("text").innerHTML = "BBB";
			}
			else {
				document.getElementById("text").innerHTML = "AAA";
			}
		}
		*/
	</script>
</html>

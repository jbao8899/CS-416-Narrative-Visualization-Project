<html lang="en-US">
	<head>
		<title>CS 416 Narrative Visualization Project</title>
		<script src='https://d3js.org/d3.v5.min.js'></script>
  	</head>
    <body onload='init()'>
        <div id="visualizationDiv">
            <svg id="svgForPlot" width=600 height=600></svg>
            <svg id="svgForLegend" height=375 width=300></svg>
        </div>

        <div id="sliderDiv">
            <!--https://stackoverflow.com/a/18936328-->
            <p style="display:inline">Year: </p>
            <input id="yearSlider" type="range" step="1" value="2020" min="1960" max="2021" oninput="yearChanged()" />
            <output id="yearSliderOutput">2020</output>
        </div>

        <div id="textDiv" style="width:900px;">
            <p id="tooltipDescriptor" style="font-size:150%;">Mouse over the bars to see exact data values</p>

            <p id="text" style="font-size:24px;">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>

            <a id="prevLink" style="font-size:30px;" href="index.html">Previous Slide</a>
            <a id="nextLink" style="font-size:30px;float:right;" href="page3.html">Next Slide</a>
        </div>
    </body>

	<script>
        // We will display information about 2021 by default, but will check
        // to see if another valid year was passed in as a parameter.
        // if so, we will use that year instead
        var yearToDisplay = document.getElementById("yearSlider").value;
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("Year")) {
            var parsedYear = parseInt(urlParams.get("Year"));
            if (parsedYear != null &&
                1960 <= parsedYear &&
                parsedYear<= 2021) {
                
                // Display data for the year specified in the URL
                yearToDisplay = parsedYear;

                // Show that year in the slider
                document.getElementById("yearSlider").value = yearToDisplay;
                document.getElementById("yearSliderOutput").value = yearToDisplay;

                // remember what year to display when moving to other pages
                document.getElementById("prevLink").href = `index.html?Year=${yearToDisplay}`;
                document.getElementById("nextLink").href = `page3.html?Year=${yearToDisplay}`;
            }
        }

        // initialize the various other variables needed
        var data;
        var xScale = d3.scaleBand()
                       .domain(["East Asia & Pacific",
                                "North America",
                                "Europe & Central Asia",
                                "Latin America & Caribbean",
                                "South Asia",
                                "Middle East & North Africa",
                                "Sub-Saharan Africa"])
                       .range([0, 400])
		var yScale = d3.scaleLinear().domain([0, 9]).range([400, 0])
        var colorScale = d3.scaleOrdinal()
                           .domain(["East Asia & Pacific",
                                    "North America",
                                    "Europe & Central Asia",
                                    "Latin America & Caribbean",
                                    "South Asia",
                                    "Middle East & North Africa",
                                    "Sub-Saharan Africa"])
                           .range(["brown",
                                   "purple",
                                   "blue",
                                   "lightblue",
                                   "green",
                                   "orange",
                                   "red"]);

        async function init() {
            // load the data
			data = await d3.csv("https://raw.githubusercontent.com/jbao8899/CS-416-Narrative-Visualization-Project/main/project_2_data.csv");
						
            // Plot the axes
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 100)")
			  .call(d3.axisLeft(yScale));
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 500)")
			  .call(d3.axisBottom(xScale)
					  .tickFormat(""));

            // Plot the axis labels and chart title
            // https://stackoverflow.com/questions/11189284/d3-axis-labeling
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 545)
              .attr("font-size", "24px")
              .text("Region");
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "y label")
              .attr("text-anchor", "middle")
              .attr("x", -300)
              .attr("y", 65)
              .attr("font-size", "24px")
              .attr("transform", "rotate(-90)")
              .text("Weighted Mean Fertility Rate");
            d3.select("#svgForPlot")
              .append("text")
              .attr("id", "plotTitle")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 85)
              .attr("font-size", "30px")
              .text(`Regional Fertility Rates (${yearToDisplay})`);

            // Create the legend
            // https://d3-graph-gallery.com/graph/custom_legend.html (Categorical legend: square)
            // select the svg area
            var svgForLegend = d3.select("#svgForLegend")

            // create a list of keys
            var keys = ["East Asia & Pacific",
                        "North America",
                        "Europe & Central Asia",
                        "Latin America & Caribbean",
                        "South Asia",
                        "Middle East & North Africa",
                        "Sub-Saharan Africa"]

            // I already have a color scale
            // var color = d3.scaleOrdinal()
            //     .domain(keys)
            //     .range(d3.schemeSet1);

            // Add one rectangle in the legend for each region.
            var size = 20
            svgForLegend.selectAll("mydots")
                        .data(keys)
                        .enter()
                        .append("rect")
                        .attr("x", 100)
                        .attr("y", function(d,i){ return i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
                        .attr("width", size)
                        .attr("height", size)
                        .style("fill", function(d){ return colorScale(d)})

            // Add the name of each region
            svgForLegend.selectAll("mylabels")
                        .data(keys)
                        .enter()
                        .append("text")
                        .attr("x", 100 + size*1.2)
                        .attr("y", function(d,i){ return i*(size+5) + (size/2)}) // 100 is where the first dot appears. 25 is the distance between dots
                        .style("fill", function(d){ return colorScale(d)})
                        .text(function(d){ return d})
                        .attr("text-anchor", "left")
                        .style("alignment-baseline", "middle")
            
            // Actually render the bars
            renderBars();
		}

        function renderBars() {
            // get the data corresponding to the year currently being displayed 
            var dataToPlot = data.filter(function(d) { return d.Year == yearToDisplay })
            // get rid of data for which the fertility rate or population are missing
            dataToPlot = dataToPlot.filter(function(d) { return d.FertilityRate != "" })
            dataToPlot = dataToPlot.filter(function(d) { return d.TotalPopulation != "" })

            // clear any points which may already be there
            d3.select("#svgForPlot").selectAll("rect").remove();

            // Find the total population of each region
            // https://stackoverflow.com/a/40206462
            var regionPops = d3.nest()
                              .key(
                                  function(d) {
                                      return d.Region; 
                                  }
                              )
                              .rollup(
                                  function(leaves) {
                                      return d3.sum(leaves, function(d) { return d.TotalPopulation; });
                                  }
                              )
                              .entries(dataToPlot)
                              .map(
                                  function(d) {
                                      return { Region: d.key, TotalPopulation: d.value};
                                  }
                              ) 
                              .reduce( // https://stackoverflow.com/a/44325124
                                  (obj, item) => Object.assign(obj, { [item.Region]: item.TotalPopulation }),
                                  {}
                              )
            
            // sum these within each region to get a weighted
            // average fertility rate for that region
            dataToPlot.forEach(function(d) {
                d.WeightedFertilityRate = (d.FertilityRate * d.TotalPopulation) / regionPops[d.Region]
            });

            // Get the weighted mean fertility rate for each region
            // https://stackoverflow.com/a/40206462
            dataToPlot = d3.nest()
                           .key(
                               function(d) {
                                   return d.Region; 
                               }
                           )
                           .rollup(
                               function(leaves) {
                                   return d3.sum(leaves, function(d) { return d.WeightedFertilityRate; });
                               }
                           )
                           .entries(dataToPlot)
                           .map(
                               function(d) {
                                   return { Region: d.key, WeightedMeanFertilityRate: d.value};
                               }
                           );

            // Make the bars be in order, with the bar corresponding to the region with
            // the smallest weighted average fertility on the left
            // and the largest on the right
            // // https://stackoverflow.com/a/46208867
            // dataToPlot.sort(function(a, b) {
            //     return d3.ascending(a.WeightedMeanFertilityRate, b.WeightedMeanFertilityRate)
            // })
            
            // Having the bars move about as the year changes is confusing,
            // so it is better to do this:
            // I make the bars be in a fixed order
            // (sorted in ascending order of fertility in 2020)
            for (var i = 0; i < dataToPlot.length; i++) {
                if (dataToPlot[i].Region == "East Asia & Pacific") {
                    dataToPlot[i].OrderVar = 1;
                }
                else if (dataToPlot[i].Region == "North America") {
                    dataToPlot[i].OrderVar = 2;
                }
                else if (dataToPlot[i].Region == "Europe & Central Asia") {
                    dataToPlot[i].OrderVar = 3;
                }
                else if (dataToPlot[i].Region == "Latin America & Caribbean") {
                    dataToPlot[i].OrderVar = 4;
                }
                else if (dataToPlot[i].Region == "South Asia") {
                    dataToPlot[i].OrderVar = 5;
                }
                else if (dataToPlot[i].Region == "Middle East & North Africa") {
                    dataToPlot[i].OrderVar = 6;
                }
                else { // Sub-Saharan Africa
                    dataToPlot[i].OrderVar = 7;
                }
            }
            dataToPlot.sort(function(a, b) {
                return d3.ascending(a.OrderVar, b.OrderVar)
            })


            // Plot the bars
			d3.select("#svgForPlot")
			  .attr("width", 400 + 2 * 100)
			  .attr("height", 400 + 2 * 100)
			  .append("g")
			  .attr("transform","translate(100, 100)")
			  .selectAll("rect")
			  .data(dataToPlot)
			  .enter()
			  .append("rect")
              .attr("x", function(d, i) { return 14 + ((400 / 7) * i) })
              .attr("y", function(d) { return 400 - ((d.WeightedMeanFertilityRate / 9) * 400) })
              .attr("width", 200 / 7)
              .attr("height", function(d) { return (d.WeightedMeanFertilityRate / 9) * 400 })
              .style("fill", function(d) {return colorScale(d.Region);})
              .on("mouseover mousemove",
                  function(d, i) {
                      var regionNameForPrinting = "";
                    
                      if (d.Region == "East Asia & Pacific") {
                          regionNameForPrinting = "East Asia and the Pacific";
                      }
                      else if (d.Region == "North America") {
                          regionNameForPrinting = d.Region;
                      }
                      else if (d.Region == "Europe & Central Asia") {
                          regionNameForPrinting = "Europe and Central Asia";
                      }
                      else if (d.Region == "Latin America & Caribbean") {
                          regionNameForPrinting = "Latin America and the Caribbean";
                      }
                      else if (d.Region == "South Asia") {
                          regionNameForPrinting = "South Asia";
                      }
                      else if (d.Region == "Middle East & North Africa") {
                          regionNameForPrinting = "the Middle East and North Africa"
                      }
                      else {
                          regionNameForPrinting = d.Region;
                      }

                      document.getElementById("tooltipDescriptor")
                        .innerHTML = `In ${yearToDisplay}, the weighted mean fertility rate in ${regionNameForPrinting} was ${Math.round(d.WeightedMeanFertilityRate * 100) / 100} children per woman.`;
                  }                    
              )
              .on("mouseout",
                  function() {
                      document.getElementById("tooltipDescriptor")
                          .innerHTML = "Mouse over the bars to see exact data values";
                  }
              );
        }

        function yearChanged() {
            // Get the new year for which we will show data
            yearToDisplay = document.getElementById("yearSlider").value;

            // Show the year for which we will plot data next to the slider
            document.getElementById("yearSliderOutput").value = yearToDisplay;

            // remember what year to display when moving to other pages
            document.getElementById("prevLink").href = `index.html?Year=${yearToDisplay}`;
            document.getElementById("nextLink").href = `page3.html?Year=${yearToDisplay}`;

            // Change the plot's title to reflect the change
            // in year for which data is being plotted
            d3.select("#plotTitle")
              .text(`Regional Fertility Rates (${yearToDisplay})`);
            
            // render the points for the next year
            renderBars();
        }
    </script>
</html>

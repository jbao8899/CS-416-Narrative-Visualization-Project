<html lang="en-US">
	<head>
		<title>CS 416 Narrative Visualization Project</title>
		<script src='https://d3js.org/d3.v5.min.js'></script>
  	</head>
	<body onload="init()">
        <div id="visualizationDiv">
			<svg id="svgForPlot" width=600 height=600></svg>
            <svg id="svgForLegend" height=375 width=300></svg>
		</div>

        <div id="sliderDiv">
            <!--https://stackoverflow.com/a/18936328-->
            <p style="display:inline">Year: </p>
            <input id="yearSlider" type="range" step="1" value="2020" min="1960" max="2021" oninput="yearChanged()" />
            <output id="yearSliderOutput">2020</output>
        </div>

		<div id="linkDiv">
			<a id="prevLink" href="page2.html">Previous Slide</a>
		</div>
	</body>

	<script>
        // We will display information about 2021 by default, but will check
        // to see if another valid year was passed in as a parameter.
        // if so, we will use that year instead
        var yearToDisplay = document.getElementById("yearSlider").value;
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("Year")) {
            var parsedYear = parseInt(urlParams.get("Year"))
            if (parsedYear != null &&
                1960 <= parsedYear &&
                parsedYear<= 2021) {

                // Display data for the year specified in the URL
                yearToDisplay = parsedYear;

                // Show that year in the slider
                document.getElementById("yearSlider").value = yearToDisplay;
                document.getElementById("yearSliderOutput").value = yearToDisplay;
                
                // remember what year to display when moving to other pages
                document.getElementById("prevLink").href = `page2.html?Year=${yearToDisplay}`;
            }
        }

        // initialize the various variables needed
        var data;
        var xScale = d3.scaleLog().domain([1, 450]).range([0, 400])
		var yScale = d3.scaleLinear().domain([0, 9]).range([400, 0])
        var colorScale = d3.scaleOrdinal()
                           .domain(["East Asia & Pacific",
                                    "North America",
                                    "Europe & Central Asia",
                                    "Latin America & Caribbean",
                                    "South Asia",
                                    "Middle East & North Africa",
                                    "Sub-Saharan Africa"])
                           .range(["brown",
                                   "purple",
                                   "blue",
                                   "lightblue",
                                   "green",
                                    "orange",
                                   "red"]);

        // Function used to display everything initially
        async function init() {
            // load the data
			data = await d3.csv("https://raw.githubusercontent.com/jbao8899/CS-416-Narrative-Visualization-Project/main/project_2_data.csv");
			
            // Add the axes
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 100)")
			  .call(d3.axisLeft(yScale));
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 500)")
			  .call(d3.axisBottom(xScale)
					  .tickValues([10, 20, 50, 100, 200, 300, 400])
					  .tickFormat(d3.format("~s")));
            
            // Add the axis labels and title
            // https://stackoverflow.com/questions/11189284/d3-axis-labeling
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 535)
              .attr("font-size", "18px")
              .text("Deaths Under 5 Per 1,000 Live Births");
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "y label")
              .attr("text-anchor", "middle")
              .attr("x", -300)
              .attr("y", 65)
              .attr("font-size", "18px")
              .attr("transform", "rotate(-90)")
              .text("Fertility Rate");
            d3.select("#svgForPlot")
              .append("text")
              .attr("id", "plotTitle")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 85)
              .attr("font-size", "24px")
              .text(`Early Childhood Mortality Rate vs Fertility Rate (${yearToDisplay})`);

            // Code to create the color legend
            // https://d3-graph-gallery.com/graph/custom_legend.html (Categorical legend: square)
            // select the svg area
            var svgForLegend = d3.select("#svgForLegend")

            // create a list of keys
            var keys = ["East Asia & Pacific",
                        "North America",
                        "Europe & Central Asia",
                        "Latin America & Caribbean",
                        "South Asia",
                        "Middle East & North Africa",
                        "Sub-Saharan Africa"]

            // I already have a scale for color, so this is not needed
            // var color = d3.scaleOrdinal()
            //     .domain(keys)
            //     .range(d3.schemeSet1);

            // Add a rectangle in the legend for each region
            var size = 20
            svgForLegend.selectAll("mydots")
                        .data(keys)
                        .enter()
                        .append("rect")
                        .attr("x", 100)
                        .attr("y", function(d,i) { return i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
                        .attr("width", size)
                        .attr("height", size)
                        .style("fill", function(d) { return colorScale(d)})

            // Add the name of each region
            svgForLegend.selectAll("mylabels")
                        .data(keys)
                        .enter()
                        .append("text")
                        .attr("x", 100 + size*1.2)
                        .attr("y", function(d,i) { return i*(size+5) + (size/2)}) // 100 is where the first dot appears. 25 is the distance between dots
                        .style("fill", function(d) { return colorScale(d)})
                        .text(function(d) { return d})
                        .attr("text-anchor", "left")
                        .style("alignment-baseline", "middle")

            // Actually render the points
            renderPoints(data)
		}

        function renderPoints() {
            // get the data corresponding to the year currently being displayed
            var dataToPlot = data.filter(function(d) { return d.Year == yearToDisplay })
            
            // get rid of data for which fertility rate or mortality rate under 5 are missing
            dataToPlot = dataToPlot.filter(function(d) { return d.FertilityRate != "" })
            dataToPlot = dataToPlot.filter(function(d) { return d.Under5DeathsPer1000 != "" })

            // clear any points which may already be there
            d3.select("#svgForPlot").selectAll("circle").remove();

            // Plot the new points for the year whose data is currently being displayed
			d3.select("#svgForPlot")
			  .attr("width", 400 + 2 * 100)
			  .attr("height", 400 + 2 * 100)
			  .append("g")
			  .attr("transform","translate(100, 100)")
			  .selectAll("circle")
			  .data(dataToPlot)
			  .enter()
			  .append("circle")
			  .attr("cx", function(d) { return xScale(d.Under5DeathsPer1000); })
			  .attr("cy", function(d) { return yScale(d.FertilityRate); })
			  .attr("r", 5)
              .style("fill", function(d) {return colorScale(d.Region);});
        }

        function yearChanged() {
            // Get the new year for which we will show data
            yearToDisplay = document.getElementById("yearSlider").value;

            // Show the year for which we will plot data next to the slider
            document.getElementById("yearSliderOutput").value = yearToDisplay;

            // remember what year to display when moving to other pages
            document.getElementById("prevLink").href = `page2.html?Year=${yearToDisplay}`;

            // Change the plot's title to reflect the change
            // in year for which data is being plotted
            d3.select("#plotTitle")
              .text(`Early Childhood Mortality Rate vs Fertility Rate (${yearToDisplay})`);
            
            // render the points for the next year
            renderPoints();
        }
	</script>
</html>

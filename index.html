<!--https://d3-graph-gallery.com/graph/basic_datamanipulation.html very good-->
<!--continuous colors for ordinal values?-->
<!--Need parameters???-->
<!--What annotations? Like remark that East Asia has high fertility at first, then low?
    And that you see their fertility and mortality decreasing as time passes in scatterplot? 
    Does it have to be pointing at graph? Can I just write stuff at the bottom?-->
<!--d3.event.pageX gives coordinates on page as a whole? What to do on page with 2 graphs?-->
<!--Mortality range looks bad for 2020, but good for if years are allowed to change???-->
<!-- Execution order? Will whole script block run before the onload() for body???? -->
<!-- Eliminate gaps between lines? Margin and padding don't seem to do anything when set to 0px -->

<html lang="en-US">
	<head>
		<title>CS 416 Narrative Visualization Project</title>
		<script src='https://d3js.org/d3.v5.min.js'></script>
  	</head>
    <body onload='init()'>
        <div id="visualizationDiv">
            <svg id="svgForPlot" width=600 height=600></svg>
        </div>

        <div id="tooltipDescriptorDiv">
            <p id="tooltipDescriptorLine1" style="font-size:150%;">Mouse over the chart to see exact values</p>
            <p id="tooltipDescriptorLine2" style="font-size:150%;"> ------------------------------------------------- </p>
        </div>

        <div id="linkDiv">
            <a id="nextLink" style="font-size:24px;" href="page2.html">Next Slide</a>
        </div>

        <!-- <div id="tooltip" style="opacity:0;position:absolute"></div> -->
    </body>
	<script>
        // Although information for all years is shown here, we want to
        // remember what year was being displayed if we come here from
        // one of the upcoming slides
        var yearToDisplay = 2020;
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("Year")) {
            var parsedYear = parseInt(urlParams.get("Year"))
            if (parsedYear != null &&
                1960 <= parsedYear &&
                parsedYear<= 2021) {
                
                // Display data for the year specified in the URL
                yearToDisplay = parsedYear;

                // remember what year to display when moving to other pages
                document.getElementById("nextLink").href = `page2.html?Year=${yearToDisplay}`;
            }
        }

        // initialize the various variables needed
        var data;
        var xScale = d3.scaleLinear().domain([1960, 2021]).range([0, 400]);
        var inverseXScale = d3.scaleLinear().domain([0, 400]).range([1960, 2021]);
        var yScale = d3.scaleLinear().domain([0, 9]).range([400, 0])
        tooltip = d3.select("#tooltip")

        // Make an object mapping from years to weighted mean fertility rate
        // values will be set in init()
        var fertilityDict = { };

        async function init() {
            // load the data
			data = await d3.csv("https://raw.githubusercontent.com/jbao8899/CS-416-Narrative-Visualization-Project/main/project_2_data.csv");

            // get rid of data for which the fertility rate or population are missing
            data = data.filter(function(d) { return d.FertilityRate != "" })
            data = data.filter(function(d) { return d.TotalPopulation != "" })
            
            // Find global population in each year
            // https://stackoverflow.com/a/40206462
            var yearPops = d3.nest()
                            .key(
                                function(d) {
                                    return d.Year; 
                                }
                            )
                            .rollup(
                                function(leaves) {
                                    return d3.sum(leaves, function(d) { return d.TotalPopulation; });
                                }
                            )
                            .entries(data)
                            .map(
                                function(d) {
                                    return { Year: d.key, TotalPopulation: d.value};
                                }
                            ) 
                            .reduce( // https://stackoverflow.com/a/44325124
                                (obj, item) => Object.assign(obj, { [item.Year]: item.TotalPopulation }),
                                {}
                            )
            
            // sum WeightedFertilityRate for each year to get a weighted
            // mean global fertility rate for that year
            data.forEach(function(d) {
                d.WeightedFertilityRate = (d.FertilityRate * d.TotalPopulation) / yearPops[d.Year]
            });

            // Get the global weighted mean fertility rate for each year
            // https://stackoverflow.com/a/40206462
            data = d3.nest()
                     .key(
                          function(d) {
                              return d.Year; 
                          }
                      )
                      .rollup(
                          function(leaves) {
                              return d3.sum(leaves, function(d) { return d.WeightedFertilityRate; });
                          }
                      )
                      .entries(data)
                      .map(
                          function(d) {
                              return { Year: d.key, WeightedMeanFertilityRate: d.value};
                          }
                      );
            

            // put the data in a dictionary mapping from years to
            // weighted mean fertility rates
            for (var i = 0; i < data.length; i++) {
                fertilityDict[data[i].Year] = data[i].WeightedMeanFertilityRate;
            }

            // Plot a line showing the global weighted mean fertility rate
            // for each year
            // https://d3-graph-gallery.com/graph/line_basic.html
            d3.select("#svgForPlot")
			  .attr("width", 400 + 2 * 100)
			  .attr("height", 400 + 2 * 100)
			  .append("g")
			  .attr("transform","translate(100, 100)")
              .append("path")
            //   .on("mouseover",
            //       function (d, i) {
            //           console.log("Got here");
            //           tooltip.style("opacity", 1)
            //                  .style("left", (d3.event.pageX) + "px")
            //                  .style("top", (d3.event.pageY) + "px")
            //                  .html("TOOLTIP TEXT");
            //       })
              .datum(data)
              .attr("fill", "none")
              .attr("stroke", "black")
              .attr("stroke-width", 3)
              .attr("d",
                    d3.line()
                      .x(function(d) { return xScale(d.Year) })
                      .y(function(d) { return yScale(d.WeightedMeanFertilityRate) })
              )
            
            // Plot the axes
            d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 100)")
			  .call(d3.axisLeft(yScale));
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 500)")
			  .call(d3.axisBottom(xScale)
                      .tickFormat(d3.format("d")));

            // Add the axis labels and chart title
            // https://stackoverflow.com/questions/11189284/d3-axis-labeling
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 535)
              .attr("font-size", "18px")
              .text("Year");
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "y label")
              .attr("text-anchor", "middle")
              .attr("x", -300)
              .attr("y", 65)
              .attr("font-size", "18px")
              .attr("transform", "rotate(-90)")
              .text("Weighted Mean Fertility Rate");
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 85)
              .attr("font-size", "30px")
              .text("Global Fertility Rate Over Time");
            
            d3.select("#svgForPlot")
              .on("mouseover mousemove",
                  function() {
                      if (100 <= d3.event.pageX &&
                          d3.event.pageX <= 500 &&
                          100 <= d3.event.pageY &&
                          d3.event.pageY <= 500) {

                          //   console.log("Mousing over plot");
                          //   console.log(d3.event.pageX);
                          //   console.log(d3.event.pageY);
                          
                          d3.select("#tooltipLine")
                            .remove();
                          
                          // https://stackoverflow.com/a/26419079/
                          d3.select("#svgForPlot")
                            .append("line")
                            .attr("x1", d3.event.pageX)
                            .attr("x2", d3.event.pageX)
                            .attr("y1", 100)
                            .attr("y2", 500)
                            .style("stroke", "black")
                            .style("stroke-width", 1)
                            .style("fill", "none")
                            .style("stroke-dasharray", "5,5")
                            .attr("id", "tooltipLine");

                          var roundedYear = Math.round(inverseXScale(d3.event.pageX - 100));
                          document.getElementById("tooltipDescriptorLine1")
                                  .innerHTML = `In ${roundedYear}, the global weighted mean fertility rate`;
                          document.getElementById("tooltipDescriptorLine2")
                                  .innerHTML = `was ${Math.round(fertilityDict[roundedYear] * 100) / 100} children per woman.`;
                          //   var xInsidePlot = d3.event.pageX - 100;
                          //   var yearHoveringOver = parseInt(inverseXScale(xInsidePlot));
                          //   console.log(fertilityDict[yearHoveringOver]);
                      }                    
                  }
              )
              .on("mouseout",
                  function() {
                      d3.select("#tooltipLine")
                          .remove();
                      document.getElementById("tooltipDescriptorLine1")
                          .innerHTML = "Mouse over the chart to see exact values";
                      document.getElementById("tooltipDescriptorLine2")
                          .innerHTML = "-------------------------------------------------";
                  }
              )
		}
	</script>
</html>
<!--https://d3-graph-gallery.com/graph/basic_datamanipulation.html very good-->
<!--continuous colors for ordinal values?-->
<!--Need parameters???-->
<!--Mortality range looks bad for 2020, but good for if years are allowed to change???-->
<!-- Execution order? Will whole script block run before the onload() for body???? -->

<html lang="en-US">
	<head>
		<title>CS 416 Narrative Visualization Project</title>
		<script src='https://d3js.org/d3.v5.min.js'></script>
  	</head>
	<body onload='init()'>
		<div id="visualizationDiv">
			<svg id="svgForPlot" width=600 height=600></svg>            
		</div>
		
		<div id="sliderDiv">
			<a href="page2.html">Next Slide</a>
		</div>	
	</body>
	<script>
        // initialize the various variables needed
        var data;
        var xScale = d3.scaleLinear().domain([1960, 2021]).range([0, 400]);
        var yScale = d3.scaleLinear().domain([0, 9]).range([400, 0])

        async function init() {
            // load the data
			data = await d3.csv("https://raw.githubusercontent.com/jbao8899/CS-416-Narrative-Visualization-Project/main/project_2_data.csv");

            // get rid of data for which the fertility rate or population are missing
            data = data.filter(function(d) { return d.FertilityRate != "" })
            data = data.filter(function(d) { return d.TotalPopulation != "" })
            
            // Find global population in each year
            // https://stackoverflow.com/a/40206462
            var yearPops = d3.nest()
                            .key(
                                function(d) {
                                    return d.Year; 
                                }
                            )
                            .rollup(
                                function(leaves) {
                                    return d3.sum(leaves, function(d) { return d.TotalPopulation; });
                                }
                            )
                            .entries(data)
                            .map(
                                function(d) {
                                    return { Year: d.key, TotalPopulation: d.value};
                                }
                            ) 
                            .reduce( // https://stackoverflow.com/a/44325124
                                (obj, item) => Object.assign(obj, { [item.Year]: item.TotalPopulation }),
                                {}
                            )
            
            // sum WeightedFertilityRate for each year to get a weighted
            // mean global fertility rate for that year
            data.forEach(function(d) {
                d.WeightedFertilityRate = (d.FertilityRate * d.TotalPopulation) / yearPops[d.Year]
            });

            // Get the global weighted mean fertility rate for each year
            // https://stackoverflow.com/a/40206462
            data = d3.nest()
                     .key(
                          function(d) {
                              return d.Year; 
                          }
                      )
                      .rollup(
                          function(leaves) {
                              return d3.sum(leaves, function(d) { return d.WeightedFertilityRate; });
                          }
                      )
                      .entries(data)
                      .map(
                          function(d) {
                              return { Year: d.key, WeightedMeanFertilityRate: d.value};
                          }
                      );
            
            // Plot a line showing the global weighted mean fertility rate
            // for each year
            // https://d3-graph-gallery.com/graph/line_basic.html
            d3.select("#svgForPlot")
			  .attr("width", 400 + 2 * 100)
			  .attr("height", 400 + 2 * 100)
			  .append("g")
			  .attr("transform","translate(100, 100)")
              .append("path")
              .datum(data)
              .attr("fill", "none")
              .attr("stroke", "black")
              .attr("stroke-width", 3)
              .attr("d",
                    d3.line()
                      .x(function(d) { return xScale(d.Year) })
                      .y(function(d) { return yScale(d.WeightedMeanFertilityRate) })
              )

            // Plot the axes
            d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 100)")
			  .call(d3.axisLeft(yScale));
			d3.select("#svgForPlot")
			  .append("g")
			  .attr("transform", "translate(100, 500)")
			  .call(d3.axisBottom(xScale)
                      .tickFormat(d3.format("d")));

            // Add the axis labels and chart title
            // https://stackoverflow.com/questions/11189284/d3-axis-labeling
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 535)
              .attr("font-size", "18px")
              .text("Year");
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "y label")
              .attr("text-anchor", "middle")
              .attr("x", -300)
              .attr("y", 65)
              .attr("font-size", "18px")
              .attr("transform", "rotate(-90)")
              .text("Weighted Mean Fertility Rate");
            d3.select("#svgForPlot")
              .append("text")
              .attr("class", "x label")
              .attr("text-anchor", "middle")
              .attr("x", 300)
              .attr("y", 85)
              .attr("font-size", "24px")
              .text("Global Fertility Rate Over Time");
		}
	</script>
</html>
